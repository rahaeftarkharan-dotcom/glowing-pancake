<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø¨Ø²Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ Ú†ÛŒÙ†Ø´ Ø¯Ø§ÙˆØ±Ø§Ù† Ú©Ù†Ú¯Ø±Ù‡ Û¶Û°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a7c64a51e6.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8f9fa; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); padding: 20px; }
        .input-area { border: 1px solid #ccc; border-radius: 8px; padding: 10px; min-height: 150px; resize: vertical; font-family: monospace; }
        .btn-primary { background-color: #3f51b5; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #303f9f; transform: translateY(-1px); }
        .btn-secondary { background-color: #e0e0e0; color: #333; transition: all 0.2s; }
        .btn-secondary:hover { background-color: #bdbdbd; }
        .danger-alert { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 8px; }
        .success-alert { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 8px; }
        .read-only-overlay { opacity: 0.5; pointer-events: none; }
        .read-only-inputs textarea, .read-only-inputs input, .read-only-inputs select, .read-only-inputs button {
            pointer-events: none !important;
            cursor: default !important;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-50">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3" dir="ltr">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
            <p class="text-lg text-gray-700 font-bold" dir="rtl">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</p>
        </div>
    </div>

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-[#3f51b5] mb-2">âš½ï¸ Ø³ÛŒØ³ØªÙ… Ú†ÛŒÙ†Ø´ Ø¯Ø§ÙˆØ±Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ù†Ú¯Ø±Ù‡ Û¶Û°</h1>
        <p id="user-info" class="text-sm text-gray-600">ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª: <span id="auth-status">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span> | Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <span id="current-user-id" class="font-mono text-xs">...</span></p>
    </header>

    <!-- Ù¾Ù†Ù„ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± Ø­Ø°Ù Ø´Ø¯ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ User ID Ø§Ø³Øª -->

    <div id="main-content" class="max-w-6xl mx-auto space-y-8">
        
        <!-- Ø­Ø§Ù„Øª ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡ / Ù…Ø¯ÛŒØ±ÛŒØª -->
        <div id="access-control-area" class="card p-4 flex justify-between items-center bg-blue-50 border-l-4 border-blue-500">
            <div id="mode-display" class="font-bold text-blue-700"></div>
            <div id="manager-tools" class="flex space-x-2 space-x-reverse">
                <button id="toggle-manager-mode" class="btn-primary px-3 py-1 text-sm hidden" onclick="toggleManagerMode()">
                    <i class="fas fa-hammer"></i> <span id="manager-mode-text">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ (Ù…Ø¯ÛŒØ±)</span>
                </button>
                <button id="generate-share-link" class="btn-secondary px-3 py-1 text-sm hidden" onclick="generateShareLink()">
                    <i class="fas fa-share-alt"></i> ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ (ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡)
                </button>
            </div>
        </div>

        <!-- ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† -->
        <div id="input-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 read-only-inputs">
            
            <div class="card space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3"><i class="fas fa-users"></i> Û±. Ø¯Ø§ÙˆØ±Ø§Ù†</h2>
                <p class="text-sm text-gray-600">ÙØ±Ù…Øª: Ù†Ø§Ù…ØŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ (ÛŒØ§ Ø¢Ø²Ø§Ø¯)ØŒ Ø³Ø·Ø­ (A/B/C)ØŒ ØªÛŒÙ… Ø¨Ø§Ø²ÛŒÚ©Ù† (ÛŒØ§ -)ØŒ Ø²Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ: HH:MM-HH:MM;...)</p>
                <textarea id="referees-input" class="input-area w-full" rows="6"></textarea>
                <button onclick="saveData('referees', 'referees-input')" class="btn-primary w-full py-2"><i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§ÙˆØ±Ø§Ù†</button>
            </div>

            <div class="card space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3"><i class="fas fa-shield-alt"></i> Û². ØªÛŒÙ…â€ŒÙ‡Ø§ Ùˆ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§</h2>
                <p class="text-sm text-gray-600">ÙØ±Ù…Øª: Ù†Ø§Ù… ØªÛŒÙ…ØŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ</p>
                <textarea id="teams-input" class="input-area w-full" rows="6"></textarea>
                <button onclick="saveData('teams', 'teams-input')" class="btn-primary w-full py-2"><i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÙ…â€ŒÙ‡Ø§</button>
            </div>

            <div class="card space-y-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-3"><i class="fas fa-calendar-alt"></i> Û³. Ù…Ø³Ø§Ø¨Ù‚Ø§Øª (Ù‡ÙØªÙ‡ Ø¬Ø§Ø±ÛŒ)</h2>
                <p class="text-sm text-gray-600">ÙØ±Ù…Øª: ØªÙˆØ±Ù†Ù…Ù†ØªØŒ ØªÛŒÙ… Û±ØŒ ØªÛŒÙ… Û²ØŒ YYYY-MM-DDØŒ Ù…Ø±Ø­Ù„Ù‡ØŒ HH:MMØŒ Ø²Ù…ÛŒÙ† (1/2)ØŒ Ûµ-Ø¯Ø§ÙˆØ± (Ø¨Ù„Ù‡/Ø®ÛŒØ±)</p>
                <textarea id="matches-input" class="input-area w-full" rows="6"></textarea>
                <button onclick="saveData('matches', 'matches-input')" class="btn-primary w-full py-2"><i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</button>
            </div>

        </div>

        <!-- Ú©Ù†ØªØ±Ù„ Ùˆ Ú†ÛŒÙ†Ø´ -->
        <div class="card flex justify-center p-6 mt-6 read-only-inputs">
            <button id="generate-assignment-btn" onclick="startAssignmentProcess()" class="btn-primary py-3 px-8 text-xl font-bold rounded-full transition duration-300 transform hover:scale-105">
                <i class="fas fa-magic"></i> ğŸ¯ ØªÙˆÙ„ÛŒØ¯ Ú†ÛŒÙ†Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯
            </button>
        </div>

        <!-- Ù†ØªÛŒØ¬Ù‡ Ú†ÛŒÙ†Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯ -->
        <div class="card mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2"><i class="fas fa-clipboard-list"></i> Ù†ØªÛŒØ¬Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ú†ÛŒÙ†Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
            
            <div id="assignment-result" class="space-y-4">
                <p class="text-gray-500">Ù¾Ø³ Ø§Ø² ØªÙˆÙ„ÛŒØ¯ Ú†ÛŒÙ†Ø´ØŒ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
            </div>
            
            <div id="quota-warnings" class="mt-4 space-y-2"></div>

            <div class="mt-6 flex justify-end space-x-4 space-x-reverse read-only-inputs">
                <button id="final-save-btn" onclick="saveAssignment()" class="py-2 px-6 text-white font-bold rounded-lg opacity-50 cursor-not-allowed" style="background-color: #f44336;" disabled>
                    <i class="fas fa-lock"></i> Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ (Ø±ÙØ¹ ØªÙ†Ø§Ù‚Ø¶ Ù„Ø§Ø²Ù… Ø§Ø³Øª)
                </button>
            </div>
        </div>

        <!-- Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ -->
        <div class="card mt-8" id="evaluation-panel">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2"><i class="fas fa-chart-line"></i> ğŸ“Š Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ø§ÙˆØ±Ø§Ù†</h2>
            
            <div id="evaluation-controls" class="space-y-4 read-only-inputs">
                <p class="font-semibold text-lg">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ:</p>
                <select id="evaluation-match-select" class="w-full p-2 border rounded-lg bg-gray-50"></select>
                <button id="load-eval-btn" onclick="loadEvaluationForm()" class="btn-primary py-2 px-4" disabled><i class="fas fa-file-alt"></i> Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
            </div>

            <div id="evaluation-form-area" class="mt-6">
                <!-- ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>
        </div>

    </div>
    
    <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ø­Ù„ ØªÙ†Ø§Ù‚Ø¶ -->
    <div id="conflict-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4" dir="rtl">
            <h3 class="text-2xl font-extrabold text-[#f44336] mb-4 border-b pb-2"><i class="fas fa-exclamation-triangle"></i> ØªÙ†Ø§Ù‚Ø¶ Ø­ÛŒØ§ØªÛŒ Ø¯Ø± Ú†ÛŒÙ†Ø´!</h3>
            <p class="text-gray-700 mb-4">Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ù…Ù†ÙˆØ¹ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø§Ù‚Ø¶Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§ÙˆØ± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø±ÙØ¹ Ú©Ù†ÛŒØ¯.</p>
            
            <div id="conflict-list" class="space-y-6 max-h-96 overflow-y-auto pr-2">
                <!-- Conflict items will be loaded here -->
            </div>
            
            <div id="conflict-status-message" class="mt-6 font-bold text-center"></div>

            <div class="mt-6 flex justify-end">
                <button id="close-conflict-modal" onclick="closeConflictModal()" class="btn-primary py-2 px-6 bg-gray-500 hover:bg-gray-600" disabled>
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Script Block -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let isManager = false; // Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª (Ø¨Ø± Ø§Ø³Ø§Ø³ USER ID)
        let isReadOnly = true;  // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡

        // *** Ø´Ù†Ø§Ø³Ù‡ Ù…Ø¯ÛŒØ±: Ø§ÛŒÙ† ID Ø¨Ø§ÛŒØ¯ Ø¨Ø§ '05836892850460806157' Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯ ***
        const MANAGER_USER_ID = '05836892850460806157'; 
        let isManagerMode = false; // Ø­Ø§Ù„Øª Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù‚ÙˆØ§Ù†ÛŒÙ† (ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ)

        // Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
        let storedData = { referees: [], teams: {}, matches: [], assignment: [], evaluations: [] };
        let currentConflicts = [];
        let allReferees = []; // Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø¯Ø§ÙˆØ±Ø§Ù† (ØªØ¬Ø²ÛŒÙ‡ Ø´Ø¯Ù‡)
        let allTeams = {};   // Ù…Ù¾ ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ (ØªØ¬Ø²ÛŒÙ‡ Ø´Ø¯Ù‡)

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù†Ù‚Ø´
        const BASE_ROLES = ['Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„', 'Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ…', 'Ø¯Ø§ÙˆØ± Ù…ÛŒØ²'];
        const EXTRA_ROLES = ['Ø¯Ø§ÙˆØ± Ø®Ø· Û±', 'Ø¯Ø§ÙˆØ± Ø®Ø· Û²'];
        const ALL_ROLES = [...BASE_ROLES, ...EXTRA_ROLES];
        
        // Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ
        const EVALUATION_CRITERIA = {
            'presence_discipline': 'Û±. Ø­Ø¶ÙˆØ± Ùˆ Ù†Ø¸Ù… (Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ Ø¨ÙˆØ¯Ù†ØŒ Ù¾ÙˆØ´Ø´ØŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª)',
            'focus': 'Û². ØªÙ…Ø±Ú©Ø² Ø¯Ø± Ø¨Ø§Ø²ÛŒ (Ø¯Ù‚Øª Ùˆ Ù¾Ø§ÛŒØ´)',
            'field_control': 'Û³. ØªØ³Ù„Ø· Ø¨Ø± Ø²Ù…ÛŒÙ† (Ù¾ÙˆØ´Ø´ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÚ¯ÛŒØ±ÛŒ)',
            'behavior_management': 'Û´. Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙØªØ§Ø± Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ (Ú©Ù†ØªØ±Ù„ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ùˆ Ø³Ø±Ù¾Ø±Ø³ØªØ§Ù†)',
            'tension_management': 'Ûµ. Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¶Ø§ÛŒ Ù…Ø³Ø§Ø¨Ù‚Ù‡ (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ´Ù†Ø¬)',
            'authority_use': 'Û¶. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø®ØªÛŒØ§Ø±Ø§Øª (Ø¨Ù‡â€ŒÙ…ÙˆÙ‚Ø¹ Ø¨ÙˆØ¯Ù† Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§)',
            'rules_mastery': 'Û·. ØªØ³Ù„Ø· Ø¨Ø± Ù‚ÙˆØ§Ù†ÛŒÙ† (Ø¹Ø¯Ù… Ø§Ø´ØªØ¨Ø§Ù‡ Ø¯Ø± Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø¯ÛŒÙ‡ÛŒ)',
            'impactful_mistakes': 'Û¸. Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø±',
            'team_coordination': 'Û¹. Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ ØªÛŒÙ…ÛŒ (Ø¨Ø§ Ø³Ø§ÛŒØ± Ø¯Ø§ÙˆØ±Ø§Ù†)',
            'overall_score': 'Û±Û°. Ù†Ù…Ø±Ù‡ Ú©Ù„ÛŒ (Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯)',
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
        const parseTime = (timeStr) => {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes; // Ø²Ù…Ø§Ù† Ø¨Ø± Ø­Ø³Ø¨ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ù†ÛŒÙ…Ù‡ Ø´Ø¨
        };

        const formatTime = (minutes) => {
            const h = Math.floor(minutes / 60).toString().padStart(2, '0');
            const m = (minutes % 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        };

        const parseUnavailability = (unavailabilityStr) => {
            if (!unavailabilityStr) return [];
            return unavailabilityStr.split(';').map(range => {
                const [start, end] = range.trim().split('-');
                if (start && end) {
                    return {
                        start: parseTime(start.trim()),
                        end: parseTime(end.trim())
                    };
                }
                return null;
            }).filter(r => r);
        };
        
        const parseData = (key, dataStr) => {
            const lines = dataStr.trim().split('\n').filter(line => line.trim() !== '');
            const parsed = [];
            
            for (const line of lines) {
                const parts = line.split(',').map(p => p.trim());
                if (key === 'referees' && parts.length >= 4) {
                    parsed.push({
                        name: parts[0],
                        branch: parts[1],
                        level: parts[2].toUpperCase(), // A, B, C
                        playerTeam: parts[3] !== '-' ? parts[3] : null,
                        unavailability: parseUnavailability(parts[4] || ''),
                        scoreHistory: []
                    });
                } else if (key === 'teams' && parts.length === 2) {
                    parsed.push({ name: parts[0], branch: parts[1] });
                } else if (key === 'matches' && parts.length >= 8) {
                    parsed.push({
                        tournament: parts[0],
                        team1: parts[1],
                        team2: parts[2],
                        date: parts[3],
                        stage: parts[4], // Ú¯Ø±ÙˆÙ‡ÛŒØŒ Ø­Ø°ÙÛŒØŒ Ù†ÛŒÙ…Ù‡ Ù†Ù‡Ø§ÛŒÛŒØŒ Ø±Ø¯Ù‡ Ø¨Ù†Ø¯ÛŒØŒ ÙÛŒÙ†Ø§Ù„
                        time: parts[5], // HH:MM
                        field: parts[6], // 1 ÛŒØ§ 2
                        is5Ref: parts[7].toLowerCase() === 'Ø¨Ù„Ù‡' || parts[7].toLowerCase() === 'yes'
                    });
                }
            }
            return parsed;
        };

        const transformInputData = () => {
            allReferees = storedData.referees;
            allTeams = storedData.teams.reduce((acc, team) => {
                acc[team.name] = team.branch;
                return acc;
            }, {});
        };

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ UI ---
        const getDocRef = (collectionName) => {
            if (db) return doc(db, 'artifacts', appId, 'public', 'data', collectionName, 'data');
            return null;
        };
        
        const checkAccessAndSetMode = () => {
            const statusEl = document.getElementById('auth-status');
            const modeDisplayEl = document.getElementById('mode-display');
            const mainContentEl = document.getElementById('main-content');
            const readOnlyContainer = document.querySelector('.read-only-inputs');

            // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¯ÛŒØ±
            isManager = userId === MANAGER_USER_ID; 
            isReadOnly = !isManager; 

            if (isReadOnly) {
                // --- Ø­Ø§Ù„Øª Read-Only (Ù¾ÛŒØ´â€ŒÙØ±Ø¶) ---
                mainContentEl.classList.add('read-only-overlay');
                readOnlyContainer.classList.add('read-only-inputs');
                modeDisplayEl.innerHTML = `<i class="fas fa-eye text-yellow-600"></i> **Ø­Ø§Ù„Øª ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡:** Ø¯Ø³ØªØ±Ø³ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø¯Ø§Ø±ÛŒØ¯.`;
                document.getElementById('manager-tools').classList.add('hidden');
            } else if (isManager) {
                // --- Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ± (Full Access) ---
                mainContentEl.classList.remove('read-only-overlay');
                readOnlyContainer.classList.remove('read-only-inputs');
                
                document.getElementById('generate-share-link').classList.remove('hidden');
                document.getElementById('toggle-manager-mode').classList.remove('hidden');
                document.getElementById('manager-tools').classList.remove('hidden');

                modeDisplayEl.innerHTML = `<i class="fas fa-user-shield text-green-700"></i> **Ù…Ø¯ÛŒØ±:** Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ (ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ú†ÛŒÙ†Ø´).`;
            } 
            
            statusEl.textContent = isManager ? 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…' : 'Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡';
            updateManagerModeUI();
        };

        const updateManagerModeUI = () => {
            if (!isManager) return;

            const btn = document.getElementById('toggle-manager-mode');
            const textEl = document.getElementById('manager-mode-text');
            const content = document.getElementById('main-content');
            const readOnlyContainer = document.querySelector('.read-only-inputs');

            if (isManagerMode) {
                content.style.borderColor = '#f44336';
                content.style.borderWidth = '2px';
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                textEl.textContent = 'ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ (Ø®Ø·Ø±Ù†Ø§Ú©)';
                readOnlyContainer.classList.remove('read-only-inputs'); 
            } else {
                content.style.borderColor = '';
                content.style.borderWidth = '';
                btn.classList.add('btn-primary');
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                textEl.textContent = 'ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ (Ù…Ø¯ÛŒØ±)';
                if (isManager) readOnlyContainer.classList.remove('read-only-inputs');
            }
            updateFinalSaveButton();
        };
        
        window.toggleManagerMode = () => {
            if (isManager) {
                isManagerMode = !isManagerMode;
                updateManagerModeUI();
                if (isManagerMode) {
                    showMessage('access-control-area', 'Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯! Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ ØªÙ†Ø§Ù‚Ø¶ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.', 'danger');
                } else {
                    showMessage('access-control-area', 'Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯.', 'success');
                }
            }
        };
        
        window.generateShareLink = () => {
            const baseUrl = window.location.href.split('?')[0]; 
            const shareUrl = baseUrl;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showMessage('access-control-area', 'Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ (ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡) Ú©Ù¾ÛŒ Ø´Ø¯. Ù‡Ø± Ú©Ø³ Ø¨Ø¯ÙˆÙ† User ID Ù…Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ØŒ Ø­Ø§Ù„Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø§ Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª.', 'success');
            }).catch(err => {
                showMessage('access-control-area', 'Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ: ' + err, 'danger');
            });
        };
        
        // --- ØªÙˆØ§Ø¨Ø¹ Firestore ---
        const showLoading = (show) => {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        };
        
        const setupFirestoreListeners = () => {
            if (!db) return;
            const collections = ['referees', 'teams', 'matches', 'assignment', 'evaluations'];
            
            collections.forEach(key => {
                onSnapshot(getDocRef(key), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data().data || [];
                        storedData[key] = data;
                        if (key === 'teams' || key === 'referees') {
                            transformInputData(); 
                        }
                        if (key === 'assignment') {
                            displayAssignmentResult(storedData.assignment);
                            populateMatchSelect(storedData.assignment);
                        } else if (key === 'referees' || key === 'teams' || key === 'matches') {
                            const inputId = `${key}-input`;
                            const inputEl = document.getElementById(inputId);
                            if (inputEl) {
                                inputEl.value = storedData[key].map(item => {
                                    if (key === 'referees') {
                                        return `${item.name}, ${item.branch}, ${item.level}, ${item.playerTeam || '-'}, ${item.unavailability.map(u => `${formatTime(u.start)}-${formatTime(u.end)}`).join(';')}`;
                                    } else if (key === 'teams') {
                                        return `${item.name}, ${item.branch}`;
                                    } else if (key === 'matches') {
                                        return `${item.tournament}, ${item.team1}, ${item.team2}, ${item.date}, ${item.stage}, ${item.time}, ${item.field}, ${item.is5Ref ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±'}`;
                                    }
                                }).join('\n');
                            }
                        }
                    } else {
                        storedData[key] = [];
                        if (key === 'assignment') displayAssignmentResult([]);
                    }
                });
            });
        };

        window.saveData = async (key, inputId) => {
            if (isReadOnly && !isManager) return showMessage('input-section', 'ÙÙ‚Ø· Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø¬Ø§Ø²Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø§Ø±Ù†Ø¯.', 'danger');
            if (!db) return showMessage('input-section', 'Ø®Ø·Ø§: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.', 'danger');

            const dataStr = document.getElementById(inputId).value;
            let parsedData;
            
            try {
                if (key === 'teams') {
                    parsedData = parseData('teams', dataStr);
                } else if (key === 'referees') {
                    parsedData = parseData('referees', dataStr);
                } else if (key === 'matches') {
                    parsedData = parseData('matches', dataStr);
                } else {
                    return;
                }
            } catch (error) {
                console.error("Parsing Error:", error);
                showMessage('input-section', `Ø®Ø·Ø§ Ø¯Ø± ØªØ¬Ø²ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ${key}: ÙØ±Ù…Øª ÙˆØ±ÙˆØ¯ÛŒ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª.`, 'danger');
                return;
            }

            try {
                showLoading(true);
                const docRef = getDocRef(key);
                await setDoc(docRef, { data: parsedData });
                showMessage('input-section', `Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ${key} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.`, 'success');
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage('input-section', 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³.', 'danger');
            } finally {
                showLoading(false);
            }
        };

        // --- Ù…Ù†Ø·Ù‚ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ---
        const setupAuth = async () => {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                // --- Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ User ID Ø¯Ø± Ù…Ø­ÛŒØ· Ù…Ø­Ù„ÛŒ ---
                document.getElementById('auth-status').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³.';
                
                // Ø§Ø² User ID ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ¹Ø§Ù„ Ø´ÙˆØ¯
                userId = MANAGER_USER_ID; 
                document.getElementById('current-user-id').textContent = userId; 
                
                isAuthReady = true;
                checkAccessAndSetMode();
                showMessage('access-control-area', 'Ù‡Ø´Ø¯Ø§Ø±: Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø­Ù„ÛŒØŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯!', 'danger');
                
                return; // Ø§Ø² Ø§ØªØµØ§Ù„ Ø¨Ù‡ Firebase Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            }

            // --- Ø§Ø¬Ø±Ø§ÛŒ Firebase Ø¯Ø± Ù…Ø­ÛŒØ· Ù…ÛŒØ²Ø¨Ø§Ù†ÛŒ ---
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            document.getElementById('auth-status').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...';

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    } catch (error) {
                        console.error("Authentication failed: ", error);
                        userId = 'anonymous-' + Math.random().toString(36).substring(2, 9);
                    }
                }
                
                document.getElementById('current-user-id').textContent = userId;
                isAuthReady = true;
                checkAccessAndSetMode();
                setupFirestoreListeners();
            });
        };

        window.onload = setupAuth;

        // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ú†ÛŒÙ†Ø´ (Smart Assignment Logic) ---
        
        // --- ØªÙˆØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª (Ineligibility Rules) ---
        
        // Ù‚Ø§Ù†ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ Û±: ØªØ¶Ø§Ø¯ Ù…Ù†Ø§ÙØ¹ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ
        const isBranchConflict = (referee, match) => {
            const refBranch = referee.branch;
            if (refBranch.toLowerCase() === 'Ø¢Ø²Ø§Ø¯') return false; 

            const team1Branch = allTeams[match.team1];
            const team2Branch = allTeams[match.team2];

            return refBranch === team1Branch || refBranch === team2Branch;
        };

        // Ù‚Ø§Ù†ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ Û²: Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­ Ùˆ Ù†Ù‚Ø´
        const isRoleLevelEligible = (referee, role, match) => {
            const level = referee.level;
            const stage = match.stage;
            const isFinalStage = ['Ù†ÛŒÙ…Ù‡ Ù†Ù‡Ø§ÛŒÛŒ', 'Ø±Ø¯Ù‡ Ø¨Ù†Ø¯ÛŒ', 'ÙÛŒÙ†Ø§Ù„'].includes(stage);

            // Ø³Ø·Ø­ C: ÙÙ‚Ø· Ø¯Ø§ÙˆØ± Ù…ÛŒØ²ØŒ Ù…Ù…Ù†ÙˆØ¹ÛŒØª Ø¯Ø± Ù…Ø±Ø§Ø­Ù„ Ø­Ø³Ø§Ø³
            if (level === 'C') {
                if (role !== 'Ø¯Ø§ÙˆØ± Ù…ÛŒØ²' && !role.startsWith('Ø¯Ø§ÙˆØ± Ø®Ø·')) return false; 
                // Ø¯Ø§ÙˆØ±Ø§Ù† Ø®Ø· (Ù¾Ø´Øª Ø¯Ø±ÙˆØ§Ø²Ù‡) Ø¨Ø±Ø§ÛŒ C Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯ Ø§Ù…Ø§ Ù†Ù‡ Ø¯Ø± Ù…Ø±Ø§Ø­Ù„ Ø­Ø³Ø§Ø³
                if (isFinalStage && (role === 'Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„' || role === 'Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ…' || role === 'Ø¯Ø§ÙˆØ± Ù…ÛŒØ²')) return false; 
            }
            
            // Ø³Ø·Ø­ B Ø¯Ø± Ù…Ø±Ø§Ø­Ù„ Ø­Ø³Ø§Ø³ (Ù†ÛŒÙ…Ù‡ Ù†Ù‡Ø§ÛŒÛŒ/ÙÛŒÙ†Ø§Ù„):
            if (level === 'B' && isFinalStage) {
                if (role === 'Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„' || role === 'Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ…') return false; // Ù…Ù…Ù†ÙˆØ¹ÛŒØª Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„ Ùˆ Ø¯ÙˆÙ…
            }
            
            // Ø³Ø·Ø­ A: Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø¬Ø§Ø²
            return true;
        };
        
        // Ù‚Ø§Ù†ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡ Û³: ØªØ¶Ø§Ø¯ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ (Ø¨Ø§Ø²ÛŒÚ©Ù† Ùˆ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ø®ØµÛŒ)
        const isTimeEligible = (referee, match) => {
            const matchTimeMins = parseTime(match.time);
            const gameDuration = 30; 

            // 1. Ø¨Ø±Ø±Ø³ÛŒ ØªØ¶Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†-Ø¯Ø§ÙˆØ±
            if (referee.playerTeam) {
                const playingMatches = storedData.matches.filter(m => 
                    m.team1 === referee.playerTeam || m.team2 === referee.playerTeam
                );

                for (const playingMatch of playingMatches) {
                    if (playingMatch.date === match.date) {
                        const playingTimeMins = parseTime(playingMatch.time);
                        
                        const conflictStart = playingTimeMins - gameDuration; 
                        const conflictEnd = playingTimeMins + gameDuration;    
                        
                        if (matchTimeMins >= conflictStart && matchTimeMins <= conflictEnd) {
                             return { eligible: false, reason: `ØªØ¶Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†-Ø¯Ø§ÙˆØ± Ø¨Ø§ Ø¨Ø§Ø²ÛŒ ØªÛŒÙ… ${referee.playerTeam} Ø¯Ø± Ø²Ù…Ø§Ù† ${playingMatch.time}.` };
                        }
                    }
                }
            }

            // 2. Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ø®ØµÛŒ
            for (const range of referee.unavailability) {
                if (matchTimeMins >= range.start && matchTimeMins < range.end) {
                    return { eligible: false, reason: `Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ Ø´Ø®ØµÛŒ (${formatTime(range.start)}-${formatTime(range.end)}).` };
                }
            }
            
            return { eligible: true };
        };

        // --- ØªØ§Ø¨Ø¹ Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª ---
        const isRefAvailableForRole = (referee, role, match, assignedRefs) => {
            if (isBranchConflict(referee, match)) {
                return { eligible: false, reason: `ØªØ¶Ø§Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø¨Ø§ ØªÛŒÙ…â€ŒÙ‡Ø§ÛŒ ${match.team1} Ùˆ ${match.team2}.` };
            }

            const timeCheck = isTimeEligible(referee, match);
            if (!timeCheck.eligible) {
                return { eligible: false, reason: timeCheck.reason };
            }

            if (!isRoleLevelEligible(referee, role, match)) {
                return { eligible: false, reason: `Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø³Ø·Ø­ ${referee.level} Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø´ ${role} Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ ${match.stage}.` };
            }

            if (assignedRefs.includes(referee.name)) {
                return { eligible: false, reason: `Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø¯Ø± Ù†Ù‚Ø´ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø®ØªØµØ§Øµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡.` };
            }
            
            return { eligible: true };
        };

        // --- Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§ØµÙ„ÛŒ Ú†ÛŒÙ†Ø´ ---
        window.startAssignmentProcess = () => {
            if (isReadOnly && !isManager) return showMessage('input-section', 'Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú†ÛŒÙ†Ø´ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± Ø´ÙˆÛŒØ¯.', 'danger');

            if (!allReferees.length || !storedData.matches.length || !Object.keys(allTeams).length) {
                return showMessage('input-section', 'Ù„Ø·ÙØ§Ù‹ Ù„ÛŒØ³Øª Ø¯Ø§ÙˆØ±Ø§Ù†ØŒ ØªÛŒÙ…â€ŒÙ‡Ø§ Ùˆ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø±Ø§ ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.', 'danger');
            }
            
            showLoading(true);
            currentConflicts = [];
            const newAssignment = [];
            
            const sortedRefs = [...allReferees].sort((a, b) => {
                const levels = { A: 3, B: 2, C: 1 };
                return levels[b.level] - levels[a.level];
            });
            
            const sortedMatches = storedData.matches.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA - dateB !== 0) return dateA - dateB;
                return parseTime(a.time) - parseTime(b.time);
            });

            for (const match of sortedMatches) {
                const matchRoles = match.is5Ref ? ALL_ROLES : BASE_ROLES;
                const matchAssignment = { matchId: match.date + match.time + match.team1, match: match, assignment: {} };
                let assignedRefsNames = []; 

                for (const role of matchRoles) {
                    let eligibleCandidates = [];
                    let bestLevel = null;
                    
                    for (const ref of sortedRefs) {
                        const check = isRefAvailableForRole(ref, role, match, assignedRefsNames);
                        if (check.eligible) {
                            
                            // Ø§Ø¹Ù…Ø§Ù„ Ø§ÙˆÙ„ÙˆÛŒØª Ø³Ø·Ø­ AØŒ BØŒ C
                            if (!bestLevel || (ref.level === 'A' && bestLevel !== 'A') || (ref.level === 'B' && bestLevel === 'C')) {
                                bestLevel = ref.level; 
                                eligibleCandidates = []; 
                            }
                            if (ref.level === bestLevel) {
                                eligibleCandidates.push(ref);
                            }
                        }
                    }
                    
                    // Ù‚Ø§Ù†ÙˆÙ† B Ø¯Ø± Ù†Ù‚Ø´ Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„ (Ø§Ú¯Ø± A Ø­Ø¶ÙˆØ± Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
                    if (role === 'Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„' && bestLevel === 'B') {
                        const aRefPresent = matchRoles.some(r => r !== 'Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„' && matchAssignment.assignment[r] && allReferees.find(ar => ar.name === matchAssignment.assignment[r].refName && ar.level === 'A'));
                        if (aRefPresent) {
                            eligibleCandidates = []; 
                        }
                    }

                    if (eligibleCandidates.length > 0) {
                        const randomIndex = Math.floor(Math.random() * eligibleCandidates.length);
                        const selectedRef = eligibleCandidates[randomIndex];
                        matchAssignment.assignment[role] = { refName: selectedRef.name, refLevel: selectedRef.level };
                        assignedRefsNames.push(selectedRef.name);
                    } else {
                        currentConflicts.push({
                            match: match,
                            role: role,
                            reason: 'Ù‡ÛŒÚ† Ø¯Ø§ÙˆØ± ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ·ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø¨Ø±Ø±Ø³ÛŒ ØªØ¶Ø§Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ/Ø²Ù…Ø§Ù†/Ø³Ø·Ø­).',
                            candidates: getConflictResolutionCandidates(role, match, assignedRefsNames),
                            tempRefName: null 
                        });
                        matchAssignment.assignment[role] = { refName: '*** ØªÙ†Ø§Ù‚Ø¶ ***', refLevel: 'X' };
                    }
                }
                newAssignment.push(matchAssignment);
            }
            
            showLoading(false);
            
            storedData.assignment = newAssignment;
            displayAssignmentResult(newAssignment);
            checkAndDisplayQuotas(newAssignment);

            if (currentConflicts.length > 0 && !isManagerMode) {
                openConflictModal();
            } else {
                updateFinalSaveButton(); 
            }
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ø­Ù„ ØªÙ†Ø§Ù‚Ø¶ ---
        const getConflictResolutionCandidates = (role, match, assignedRefsNames) => {
            const potentialRefs = [];
            for (const ref of allReferees) {
                // Ø¯Ø§ÙˆØ±Ø§Ù†ÛŒ Ú©Ù‡ ØªÙ†Ù‡Ø§ ØªØ¶Ø§Ø¯Ø´Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø³Ø·Ø­/Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø§Ø³Øª Ùˆ Ù†Ù‡ ØªØ¶Ø§Ø¯ Ø²Ù…Ø§Ù†ÛŒ/ØªÚ©Ø±Ø§Ø± Ø¯Ø± Ø¨Ø§Ø²ÛŒ.
                const isTimeConflict = !isTimeEligible(ref, match).eligible;
                const isAssigned = assignedRefsNames.includes(ref.name);

                if (!isTimeConflict && !isAssigned) {
                    const check = isRefAvailableForRole(ref, role, match, assignedRefsNames);
                    let reason = check.eligible ? 'ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ú©Ø§Ù…Ù„' : check.reason;
                    
                    potentialRefs.push({ name: ref.name, level: ref.level, reason: reason });
                }
            }
            
            return potentialRefs.sort((a, b) => {
                const levels = { A: 3, B: 2, C: 1 };
                return levels[b.level] - levels[a.level];
            });
        };
        
        window.openConflictModal = () => {
            if (currentConflicts.length === 0) return;
            document.getElementById('conflict-modal').classList.remove('hidden');
            renderConflictList();
            document.getElementById('final-save-btn').disabled = true;
            document.getElementById('close-conflict-modal').disabled = true;
        };

        window.closeConflictModal = () => {
            document.getElementById('conflict-modal').classList.add('hidden');
        };

        const renderConflictList = () => {
            const listEl = document.getElementById('conflict-list');
            listEl.innerHTML = '';
            let resolvedCount = 0;

            currentConflicts.forEach((conflict, index) => {
                if (conflict.tempRefName) {
                    resolvedCount++;
                }

                const matchInfo = `${conflict.match.tournament} (${conflict.match.stage}) - ${conflict.match.team1} vs ${conflict.match.team2} Ø¯Ø± Ø²Ù…Ø§Ù† ${conflict.match.time}`;
                const refAssigned = conflict.tempRefName || `*** Ù†Ø§Ù…Ø´Ø®Øµ ***`;
                const isResolved = !!conflict.tempRefName;

                const conflictHtml = `
                    <div class="p-4 rounded-lg ${isResolved ? 'bg-green-50' : 'bg-red-50'} border ${isResolved ? 'border-green-300' : 'border-red-300'}">
                        <p class="font-bold text-lg mb-1 ${isResolved ? 'text-green-700' : 'text-red-700'}">Ù…Ø³Ø§Ø¨Ù‚Ù‡: ${matchInfo}</p>
                        <p class="font-semibold text-gray-800">Ù†Ù‚Ø´ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${conflict.role}</p>
                        <p class="text-sm ${isResolved ? 'text-green-600' : 'text-red-600'}">Ø¯Ù„ÛŒÙ„ ØªÙ†Ø§Ù‚Ø¶: ${conflict.reason}</p>
                        <p class="mt-2 font-bold">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ù„ÛŒ: <span class="${isResolved ? 'text-green-800' : 'text-red-800'}">${refAssigned}</span></p>

                        ${!isResolved ? `
                            <div class="mt-3">
                                <p class="font-semibold text-gray-800">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†:</p>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${conflict.candidates.map(candidate => `
                                        <button onclick="resolveConflict(${index}, '${candidate.name}')" 
                                                class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-1 px-3 rounded-full transition duration-150">
                                            ${candidate.name} (${candidate.level}) <span class="text-xs text-gray-500">${candidate.reason === 'ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ú©Ø§Ù…Ù„' ? '' : '(Ù†Ù‚Ø¶ Ù‚Ø§Ù†ÙˆÙ†)'}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                listEl.innerHTML += conflictHtml;
            });

            const total = currentConflicts.length;
            const statusMsg = document.getElementById('conflict-status-message');
            
            if (resolvedCount === total) {
                statusMsg.className = 'mt-6 font-bold text-center text-green-700';
                statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> ØªØ¨Ø±ÛŒÚ©! ØªÙ…Ø§Ù…ÛŒ ${total} ØªÙ†Ø§Ù‚Ø¶ Ø±ÙØ¹ Ø´Ø¯. Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ù†ÛŒØ¯.`;
                document.getElementById('close-conflict-modal').disabled = false;
                updateFinalSaveButton(true);
            } else {
                statusMsg.className = 'mt-6 font-bold text-center text-red-700';
                statusMsg.innerHTML = `Ù„Ø·ÙØ§Ù‹ ${total - resolvedCount} Ù…ÙˆØ±Ø¯ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø±Ø§ Ø±ÙØ¹ Ú©Ù†ÛŒØ¯.`;
                updateFinalSaveButton(false);
            }
        };

        window.resolveConflict = (index, refName) => {
            currentConflicts[index].tempRefName = refName;
            
            const conflict = currentConflicts[index];
            storedData.assignment.forEach(item => {
                if (item.matchId === conflict.match.date + conflict.match.time + conflict.match.team1) {
                    item.assignment[conflict.role] = { 
                        refName: refName, 
                        refLevel: allReferees.find(r => r.name === refName).level 
                    };
                }
            });

            renderConflictList();
            displayAssignmentResult(storedData.assignment); 
        };

        const updateFinalSaveButton = (isConflictFree = currentConflicts.length === 0) => {
            const btn = document.getElementById('final-save-btn');
            if (isConflictFree || isManagerMode) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.style.backgroundColor = '#4CAF50'; 
                btn.innerHTML = `<i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ú†ÛŒÙ†Ø´`;
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.style.backgroundColor = '#f44336'; 
                btn.innerHTML = `<i class="fas fa-lock"></i> Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ (Ø±ÙØ¹ ØªÙ†Ø§Ù‚Ø¶ Ù„Ø§Ø²Ù… Ø§Ø³Øª)`;
            }
        };

        // --- Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ùˆ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ ---
        const displayAssignmentResult = (assignment) => {
            const resultEl = document.getElementById('assignment-result');
            if (!assignment || assignment.length === 0) {
                resultEl.innerHTML = '<p class="text-gray-500">Ù¾Ø³ Ø§Ø² ØªÙˆÙ„ÛŒØ¯ Ú†ÛŒÙ†Ø´ØŒ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>';
                return;
            }

            resultEl.innerHTML = assignment.map(item => {
                const isConflict = Object.values(item.assignment).some(a => a.refName === '*** ØªÙ†Ø§Ù‚Ø¶ ***');
                const rolesHtml = Object.entries(item.assignment).map(([role, ref]) => {
                    const statusClass = ref.refName === '*** ØªÙ†Ø§Ù‚Ø¶ ***' ? 'text-red-600 font-bold' : 'text-green-700';
                    return `
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <span class="text-sm text-gray-600">${role}:</span>
                            <span class="${statusClass}">${ref.refName}</span>
                            <span class="text-xs text-gray-500">(${ref.refLevel})</span>
                        </div>
                    `;
                }).join('');
                
                const assignmentId = item.matchId;

                return `
                    <div id="assignment-${assignmentId}" class="p-4 rounded-lg ${isConflict ? 'bg-red-50 border border-red-300' : 'bg-green-50 border border-green-300'}">
                        <p class="font-bold text-lg mb-2 text-gray-800">${item.match.team1} vs ${item.match.team2} (${item.match.stage} - ${item.match.time})</p>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            ${rolesHtml}
                        </div>
                        <div class="mt-3 flex justify-end space-x-2 space-x-reverse read-only-inputs">
                            <button onclick="generateMatchSummary('${item.match.tournament}', '${item.match.stage}', '${item.match.team1}', '${item.match.team2}', 'summary-output-${assignmentId}')" 
                                class="bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm py-1 px-3 rounded-full">
                                âœ¨ ØªÙˆÙ„ÛŒØ¯ Ø®Ù„Ø§ØµÙ‡ Ùˆ Ù„Ø­Ù† Ø¨Ø§Ø²ÛŒ (Gemini)
                            </button>
                        </div>
                        <div id="summary-output-${assignmentId}" class="mt-2 p-2 text-sm text-gray-700"></div>
                    </div>
                `;
            }).join('');
        };
        
        const checkAndDisplayQuotas = (assignment) => {
            const warningsEl = document.getElementById('quota-warnings');
            warningsEl.innerHTML = '<h3 class="font-bold text-lg text-gray-700 mb-2">ğŸ’¡ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø³Ù‚Ù/Ú©Ù Ú©Ø§Ø± Ù‡ÙØªÚ¯ÛŒ:</h3>';
            
            if (!assignment || assignment.length === 0) return;

            const assignmentCounts = allReferees.reduce((acc, ref) => {
                acc[ref.name] = { total: 0, first: 0, second: 0, ref: ref };
                return acc;
            }, {});

            assignment.forEach(item => {
                Object.entries(item.assignment).forEach(([role, ref]) => {
                    if (ref.refName !== '*** ØªÙ†Ø§Ù‚Ø¶ ***' && assignmentCounts[ref.refName]) {
                        assignmentCounts[ref.refName].total++;
                        if (role === 'Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„') assignmentCounts[ref.refName].first++;
                        if (role === 'Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ…') assignmentCounts[ref.refName].second++;
                    }
                });
            });

            let warningsHtml = '';
            Object.values(assignmentCounts).forEach(item => {
                const ref = item.ref;
                if (ref.level === 'A' && item.total > 5) {
                    warningsHtml += `<div class="danger-alert text-sm"><i class="fas fa-exclamation-circle"></i> **Ù‡Ø´Ø¯Ø§Ø± Ø³Ù‚Ù (A):** Ø¯Ø§ÙˆØ± ${ref.name} (${ref.level}) Ø¯Ø± ${item.total} Ø¨Ø§Ø²ÛŒ Ù‚Ø¶Ø§ÙˆØª Ø¯Ø§Ø±Ø¯ (Ø¨ÛŒØ´ Ø§Ø² Ø³Ù‚Ù Ûµ).</div>`;
                }

                if (ref.level === 'A' && (item.first + item.second < 2 || item.first < 1)) {
                    warningsHtml += `<div class="danger-alert text-sm"><i class="fas fa-exclamation-circle"></i> **Ù‡Ø´Ø¯Ø§Ø± Ú©Ù (A):** Ø¯Ø§ÙˆØ± ${ref.name} (${ref.level}) ÙÙ‚Ø· ${item.first} Ø¯Ø§ÙˆØ± Ø§ÙˆÙ„ Ùˆ ${item.second} Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ… Ø¨ÙˆØ¯Ù‡ (Ø­Ø¯Ø§Ù‚Ù„ Ú©Ø§Ø± Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯Ù‡).</div>`;
                }
                
                if (ref.level === 'B' && item.second < 1) { 
                    warningsHtml += `<div class="danger-alert text-sm"><i class="fas fa-exclamation-circle"></i> **Ù‡Ø´Ø¯Ø§Ø± Ú©Ù (B):** Ø¯Ø§ÙˆØ± ${ref.name} (${ref.level}) Ú©Ù…ØªØ± Ø§Ø² Û± Ø¨Ø§Ø²ÛŒ Ø¯Ø§ÙˆØ± Ø¯ÙˆÙ… Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</div>`;
                }
            });

            warningsEl.innerHTML += warningsHtml || '<p class="text-sm text-gray-500">Ù‡ÛŒÚ† Ù‡Ø´Ø¯Ø§Ø± Ø³Ù‚Ù ÛŒØ§ Ú©Ù Ú©Ø§Ø±ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ø´Ø¯.</p>';
        };

        window.saveAssignment = async () => {
            if (isReadOnly && !isManager) return showMessage('assignment-result', 'Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± Ø´ÙˆÛŒØ¯.', 'danger');
            if (!db) return showMessage('assignment-result', 'Ø®Ø·Ø§: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.', 'danger');

            if (currentConflicts.length > 0 && !isManagerMode) {
                return showMessage('assignment-result', 'Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ØªÙ…Ø§Ù… ØªÙ†Ø§Ù‚Ø¶Ø§Øª Ø­ÛŒØ§ØªÛŒ Ø±Ø§ Ø±ÙØ¹ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÛŒ Ø±Ø§ ÙØ¹Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯.', 'danger');
            }

            try {
                showLoading(true);
                const docRef = getDocRef('assignment');
                await setDoc(docRef, { data: storedData.assignment });
                showMessage('assignment-result', 'Ú†ÛŒÙ†Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
                currentConflicts = []; 
                updateFinalSaveButton();
            } catch (e) {
                console.error("Error saving assignment: ", e);
                showMessage('assignment-result', 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú†ÛŒÙ†Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³.', 'danger');
            } finally {
                showLoading(false);
            }
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ---
        const populateMatchSelect = (assignment) => {
            const selectEl = document.getElementById('evaluation-match-select');
            const loadBtn = document.getElementById('load-eval-btn');
            selectEl.innerHTML = '<option value="">--- Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ---</option>';

            if (!assignment || assignment.length === 0) {
                loadBtn.disabled = true;
                return;
            }

            assignment.forEach(item => {
                const matchId = item.matchId;
                const matchDisplay = `${item.match.team1} vs ${item.match.team2} (${item.match.date} ${item.match.time})`;
                const roles = Object.values(item.assignment);
                const isConflict = roles.some(a => a.refName === '*** ØªÙ†Ø§Ù‚Ø¶ ***');
                
                if (!isConflict) {
                    selectEl.innerHTML += `<option value="${matchId}">${matchDisplay}</option>`;
                }
            });
            loadBtn.disabled = selectEl.options.length <= 1;
        };

        window.loadEvaluationForm = () => {
            if (isReadOnly && !isManager) return showMessage('evaluation-panel', 'Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±Ù… Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± Ø´ÙˆÛŒØ¯.', 'danger');

            const matchId = document.getElementById('evaluation-match-select').value;
            if (!matchId) return;

            const matchAssignment = storedData.assignment.find(item => item.matchId === matchId);
            if (!matchAssignment) return;

            const formArea = document.getElementById('evaluation-form-area');
            formArea.innerHTML = '';

            Object.entries(matchAssignment.assignment).forEach(([role, ref]) => {
                const refName = ref.refName;
                const refLevel = ref.refLevel;
                const existingEvaluation = storedData.evaluations.find(e => e.matchId === matchId && e.refName === refName);
                
                const formHtml = `
                    <div id="eval-form-${refName.replace(/\s/g, '-')}" class="p-4 card mb-6 bg-gray-50 border-t-4 border-yellow-500">
                        <h4 class="text-xl font-bold mb-3 text-gray-800">${role}: ${refName} (Ø³Ø·Ø­ ${refLevel})</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${Object.entries(EVALUATION_CRITERIA).map(([key, label]) => {
                                const initialValue = existingEvaluation ? existingEvaluation.scores[key] || 5 : 5;
                                return `
                                    <div>
                                        <label for="${refName}-${key}" class="block text-sm font-medium text-gray-700">${label} (Ù†Ù…Ø±Ù‡ Û± ØªØ§ Û±Û°):</label>
                                        <input type="range" id="${refName}-${key}" min="1" max="10" value="${initialValue}" 
                                            oninput="document.getElementById('${refName}-${key}-val').textContent=this.value" 
                                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="${refName}-${key}-val" class="text-sm font-bold text-blue-600">${initialValue}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-5 flex justify-between items-center read-only-inputs">
                            <button onclick="saveEvaluation('${matchId}', '${refName}')" class="btn-primary py-2 px-4 text-sm">
                                <i class="fas fa-save"></i> Ø«Ø¨Øª Ù†Ù…Ø±Ø§Øª
                            </button>
                            <button onclick="generateFeedback('${matchId}', '${refName}', 'feedback-output-${refName.replace(/\s/g, '-')}')" 
                                class="bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm py-2 px-4 rounded-lg">
                                âœ¨ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ùˆ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ (Gemini)
                            </button>
                        </div>
                        <div id="feedback-output-${refName.replace(/\s/g, '-')}" class="mt-3 p-3 bg-white rounded-lg border text-sm">
                            ${existingEvaluation && existingEvaluation.feedback ? existingEvaluation.feedback : 'Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'}
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.saveEvaluation = async (matchId, refName) => {
            if (isReadOnly && !isManager) return showMessage('evaluation-panel', 'Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ù…Ø±Ø§Øª Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ± Ø´ÙˆÛŒØ¯.', 'danger');
            if (!db) return showMessage('evaluation-panel', 'Ø®Ø·Ø§: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.', 'danger');


            const scores = {};
            let isFormValid = true;

            Object.keys(EVALUATION_CRITERIA).forEach(key => {
                const inputEl = document.getElementById(`${refName}-${key}`);
                if (inputEl) {
                    scores[key] = parseInt(inputEl.value);
                } else {
                    isFormValid = false;
                }
            });

            if (!isFormValid) {
                return showMessage('evaluation-panel', 'Ø®Ø·Ø§: ÙØ±Ù… Ù†Ù…Ø±Ù‡â€ŒØ¯Ù‡ÛŒ Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª.', 'danger');
            }

            try {
                showLoading(true);
                const docRef = getDocRef('evaluations');
                
                const docSnapshot = await getDoc(docRef);
                let evaluations = docSnapshot.exists() ? docSnapshot.data().data || [] : [];
                
                const existingIndex = evaluations.findIndex(e => e.matchId === matchId && e.refName === refName);
                
                const newEvaluation = {
                    matchId: matchId,
                    refName: refName,
                    scores: scores,
                    timestamp: new Date().toISOString(),
                    feedback: (existingIndex !== -1) ? evaluations[existingIndex].feedback : 'Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆÙ„ÛŒØ¯.'
                };


                if (existingIndex !== -1) {
                    evaluations[existingIndex] = newEvaluation; 
                } else {
                    evaluations.push(newEvaluation); 
                }

                await setDoc(docRef, { data: evaluations });
                showMessage('evaluation-panel', `Ù†Ù…Ø±Ø§Øª Ø¯Ø§ÙˆØ± ${refName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
            } catch (e) {
                console.error("Error saving evaluation: ", e);
                showMessage('evaluation-panel', 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³.', 'danger');
            } finally {
                showLoading(false);
            }
        };

        window.generateMatchSummary = async (tournament, stage, team1, team2, outputId) => {
            const systemPrompt = `Ø´Ù…Ø§ ÛŒÚ© Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø¨Ø§ØªØ¬Ø±Ø¨Ù‡ ÙÙˆØªØ³Ø§Ù„ Ø¯Ø± Ú©Ù†Ú¯Ø±Ù‡ Û¶Û° Ù‡Ø³ØªÛŒØ¯. Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡ØŒ ÛŒÚ© Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØªØ§Ù‡ (Ø¯Ø± ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ú©ÙˆØªØ§Ù‡) Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ø­Ø³Ø§Ø³ÛŒØª Ù…Ø±Ø­Ù„Ù‡ Ùˆ Ù†Ú©Ø§Øª Ø§Ù†Ø¶Ø¨Ø§Ø·ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ø¯Ø§ÙˆØ±ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯. Ø§Ø² Ù„Ø­Ù† Ø¬Ø¯ÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø§ Ø³Ù„Ø§Ù… Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.`;
            const userQuery = `Ù…Ø³Ø§Ø¨Ù‚Ù‡: ${team1} Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± ${team2}. ØªÙˆØ±Ù†Ù…Ù†Øª: ${tournament}. Ù…Ø±Ø­Ù„Ù‡: ${stage}. Ù‡Ø¯Ù: Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø§ÙˆØ±ÛŒ.`;
            await callGeminiApi(systemPrompt, userQuery, outputId);
        };

        window.generateFeedback = async (matchId, refName, outputId) => {
            if (!db) return showMessage('evaluation-panel', 'Ø®Ø·Ø§: Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª.', 'danger');

            const currentEvaluation = storedData.evaluations.find(e => e.matchId === matchId && e.refName === refName);
            if (!currentEvaluation) return document.getElementById(outputId).innerHTML = '<span class="text-red-600">Ø§Ø¨ØªØ¯Ø§ Ù†Ù…Ø±Ø§Øª Ø¯Ø§ÙˆØ± Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</span>';
            
            const scores = currentEvaluation.scores;
            const refLevel = allReferees.find(r => r.name === refName)?.level || 'Ù†Ø§Ù…Ø´Ø®Øµ';

            let scoresText = '';
            Object.entries(scores).forEach(([key, value]) => {
                scoresText += `${EVALUATION_CRITERIA[key]}: ${value} Ø§Ø² Û±Û°.\n`;
            });

            const systemPrompt = `Ø´Ù…Ø§ ÛŒÚ© Ù…Ø±Ø¨ÛŒ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ Ø§Ø±Ø´Ø¯ Ø¯Ø§ÙˆØ±ÛŒ Ø¯Ø± Ú©Ù†Ú¯Ø±Ù‡ Û¶Û° Ù‡Ø³ØªÛŒØ¯. Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ø§Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯. Ø§Ø¨ØªØ¯Ø§ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª (Ù†Ù…Ø±Ø§Øª Ø¨Ø§Ù„Ø§) Ùˆ Ø³Ù¾Ø³ Ø¯Ùˆ Ù†Ú©ØªÙ‡ Ù‚Ø§Ø¨Ù„ Ø¨Ù‡Ø¨ÙˆØ¯ (Ù†Ù…Ø±Ø§Øª Ù¾Ø§ÛŒÛŒÙ†) Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯. Ø§Ø² Ù„Ø­Ù† Ø¯Ù„Ø³ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.`;
            const userQuery = `Ø¯Ø§ÙˆØ±: ${refName} (Ø³Ø·Ø­ ${refLevel}). Ù†Ù…Ø±Ø§Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Û±Û°Ú¯Ø§Ù†Ù‡: \n${scoresText}\n. Ù‡Ø¯Ù: ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø±Ø§Øª Ùˆ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø³Ø§Ø²Ù†Ø¯Ù‡.`;
            
            const feedbackText = await callGeminiApi(systemPrompt, userQuery, outputId);

            if (feedbackText) {
                const docRef = getDocRef('evaluations');
                
                const docSnapshot = await getDoc(docRef);
                let evaluations = docSnapshot.exists() ? docSnapshot.data().data || [] : [];
                
                const existingIndex = evaluations.findIndex(e => e.matchId === matchId && e.refName === refName);
                if (existingIndex !== -1) {
                    evaluations[existingIndex].feedback = feedbackText;
                    await setDoc(docRef, { data: evaluations });
                    loadEvaluationForm();
                }
            }
        };

        const callGeminiApi = async (systemPrompt, userQuery, outputId) => {
            const outputEl = document.getElementById(outputId);
            outputEl.innerHTML = '<div class="flex items-center space-x-2 space-x-reverse text-blue-600"><div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-blue-500"></div><span class="text-sm">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯...</span></div>';

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const API_KEY = ""; 
            const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";


            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    outputEl.innerHTML = `<i class="fas fa-magic text-purple-600"></i> ${text}`;
                    return text;
                } else {
                    outputEl.innerHTML = '<span class="text-red-600">Ø®Ø·Ø§: Ù¾Ø§Ø³Ø® Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</span>';
                    return null;
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                outputEl.innerHTML = `<span class="text-red-600">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. (${error.message})</span>`;
                return null;
            }
        };
        
        const showMessage = (targetId, message, type = 'info') => {
            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;

            const colorClass = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : (type === 'danger' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-blue-100 border-blue-400 text-blue-700');
            const icon = type === 'success' ? 'fas fa-check-circle' : (type === 'danger' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle');
            
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 mb-4 border rounded-lg ${colorClass} transition-all duration-300 transform scale-100`;
            messageEl.innerHTML = `<i class="${icon} ml-2"></i>${message}`;
            
            targetEl.prepend(messageEl);

            setTimeout(() => {
                messageEl.classList.add('opacity-0', 'scale-90');
                messageEl.addEventListener('transitionend', () => messageEl.remove());
            }, 5000);
        };

    </script>
</body>
</html>

